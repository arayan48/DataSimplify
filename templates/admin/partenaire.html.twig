{% extends 'base.html.twig' %}

{% block title %}{{ 'app.admin.partenaires'|trans }} - CITC{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/admin/sidebar.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/admin/users.css') }}">
    <style>
        body > header,
        body > footer {
            display: none;
        }
        body > main {
            padding: 0;
        }
    </style>
{% endblock %}

{% block body %}
<div class="admin-container" data-controller="partenaires"
     data-partenaires-csrf-token-value="{{ csrf_token('admin_api') }}"
     data-partenaires-add-partner-value="{{ 'app.js.partners.add_partner'|trans }}"
     data-partenaires-edit-partner-value="{{ 'app.js.partners.edit_partner'|trans }}"
     data-partenaires-confirm-delete-value="{{ 'app.js.partners.confirm_delete'|trans }}"
     data-partenaires-error-value="{{ 'app.js.partners.error'|trans }}"
     data-partenaires-select-user-value="{{ 'app.js.partners.select_user'|trans }}"
     data-partenaires-users-added-value="{{ 'app.js.partners.users_added'|trans }}"
     data-partenaires-user-removed-value="{{ 'app.js.partners.user_removed'|trans }}">
    {% include 'admin/_sidebar.html.twig' %}

    <main class="admin-content">
        <div class="page-header">
            <h1>{{ 'app.common.partners_management'|trans }}</h1>
            <div class="header-actions">
                <button class="btn btn-danger" data-action="click->partenaires#deleteSelected" data-partenaires-target="deleteBtn" disabled>
                    {{ 'app.common.delete_selection'|trans }}
                </button>
                <button class="btn btn-primary" data-action="click->partenaires#openCreateModal">
                    + {{ 'app.common.add_partner'|trans }}
                </button>
            </div>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" data-action="change->partenaires#toggleAll" data-partenaires-target="checkAll">
                        </th>
                        <th>{{ 'app.common.name'|trans }}</th>
                        <th>{{ 'app.common.telephone'|trans }}</th>
                        <th>{{ 'app.common.email'|trans }}</th>
                        <th>{{ 'app.common.city'|trans }}</th>
                        <th width="100">{{ 'app.common.actions'|trans }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for partenaire in partenaires|default([]) %}
                    <tr>
                        <td>
                            <input type="checkbox" class="partenaire-checkbox" value="{{ partenaire.id }}" 
                                data-action="change->partenaires#updateDeleteBtn" 
                                data-partenaires-target="checkbox">
                        </td>
                        <td>{{ partenaire.nom }}</td>
                        <td>{{ partenaire.telephone ?? '-' }}</td>
                        <td>{{ partenaire.email ?? '-' }}</td>
                        <td>{{ partenaire.ville ?? '-' }}</td>
                        <td>
                            <button class="btn-icon" data-action="click->partenaires#openEditModal" 
                                    data-partenaire-id="{{ partenaire.id }}"
                                    data-partenaire-nom="{{ partenaire.nom }}"
                                    data-partenaire-telephone="{{ partenaire.telephone ?? '' }}"
                                    data-partenaire-email="{{ partenaire.email ?? '' }}"
                                    data-partenaire-adresse="{{ partenaire.adresse ?? '' }}"
                                    data-partenaire-ville="{{ partenaire.ville ?? '' }}"
                                    data-partenaire-code-postal="{{ partenaire.codePostal ?? '' }}"
                                    data-partenaire-site-web="{{ partenaire.siteWeb ?? '' }}"
                                    data-partenaire-description="{{ partenaire.description ?? '' }}"
                                    title="{{ 'app.common.modify'|trans }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal" data-partenaires-target="modal">
        <div class="modal-overlay" data-action="click->partenaires#closeModal"></div>
        <div class="modal-content modal-large modal-split">
            <div class="modal-header">
                <h2 data-partenaires-target="modalTitle">{{ 'app.common.edit_partner'|trans }}</h2>
                <button class="modal-close" data-action="click->partenaires#closeModal">&times;</button>
            </div>
            <div class="modal-body-split">
                <!-- Panneau gauche : Formulaire -->
                <div class="modal-left">
                    <form data-partenaires-target="form" data-action="submit->partenaires#submitForm">
                        <input type="hidden" data-partenaires-target="partenaireId">
                        
                        <div class="form-group">
                            <label>{{ 'app.common.name'|trans }} *</label>
                            <input type="text" class="form-control" data-partenaires-target="nomInput" required>
                        </div>

                        <div class="form-group">
                            <label>{{ 'app.common.telephone'|trans }}</label>
                            <input type="tel" class="form-control" data-partenaires-target="telephoneInput">
                        </div>

                        <div class="form-group">
                            <label>{{ 'app.common.email'|trans }}</label>
                            <input type="email" class="form-control" data-partenaires-target="emailInput">
                        </div>

                        <div class="form-group">
                            <label>{{ 'app.common.address'|trans }}</label>
                            <input type="text" class="form-control" data-partenaires-target="adresseInput">
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>{{ 'app.common.city'|trans }}</label>
                                <input type="text" class="form-control" data-partenaires-target="villeInput">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>{{ 'app.common.postal_code'|trans }}</label>
                                <input type="text" class="form-control" data-partenaires-target="codePostalInput">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>{{ 'app.common.website'|trans }}</label>
                            <input type="url" class="form-control" data-partenaires-target="siteWebInput" placeholder="https://...">
                        </div>

                        <div class="form-group">
                            <label>{{ 'app.common.description'|trans }}</label>
                            <textarea class="form-control" data-partenaires-target="descriptionInput" rows="3"></textarea>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-action="click->partenaires#closeModal">{{ 'app.common.cancel'|trans }}</button>
                            <button type="submit" class="btn btn-primary">{{ 'app.common.save'|trans }}</button>
                        </div>
                    </form>
                </div>
                
                <!-- Panneau droit : Utilisateurs -->
                <div class="modal-right" data-partenaires-target="usersSection" style="display: none;">
                    <div class="users-section-header">
                        <div class="search-box">
                            <input type="text" 
                                class="form-control search-input" 
                                placeholder="{{ 'app.common.search'|trans }}"
                                data-partenaires-target="searchInput"
                                data-action="input->partenaires#filterSearchUsers">
                        </div>
                        <div class="add-user-box">
                            <button class="btn btn-primary btn-add-user" 
                                    data-action="click->partenaires#toggleAddDropdown">
                                + {{ 'app.common.add_user'|trans }}
                            </button>
                            <div class="dropdown-add-users" data-partenaires-target="addDropdown" style="display: none;">
                                <div class="dropdown-header">
                                    <input type="text" 
                                        class="form-control search-input-small" 
                                        placeholder="{{ 'app.common.search'|trans }}"
                                        data-partenaires-target="addSearchInput"
                                        data-action="input->partenaires#filterAddUsers">
                                </div>
                                <div class="dropdown-content" data-partenaires-target="addUsersList">
                                    <!-- {{ 'Liste des utilisateurs à ajouter'|trans }} -->
                                </div>
                                <div class="dropdown-footer">
                                    <button class="btn btn-primary btn-validate" 
                                            data-action="click->partenaires#validateAddUsers">
                                        {{ 'app.common.validate'|trans }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="users-list" data-partenaires-target="usersList">
                        <div class="empty-state">{{ 'app.common.empty'|trans }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de confirmation de suppression multiple -->
    <div id="deleteMultiplePartenairesModal" aria-hidden="true" inert class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-[9999] justify-center items-center w-full md:inset-0 h-modal md:h-full">
        <div class="relative p-4 w-full max-w-md h-full md:h-auto">
            <div class="relative p-4 text-center bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
                <button type="button" onclick="closeModal('deleteMultiplePartenairesModal')" class="text-gray-400 absolute top-2.5 right-2.5 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span class="sr-only">{{ 'app.common.close'|trans }}</span>
                </button>
                <svg class="text-gray-400 dark:text-gray-500 w-11 h-11 mb-3.5 mx-auto" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                <p class="mb-4 text-gray-500 dark:text-gray-300">{{ 'app.js.partners.confirm_delete_message'|trans }}</p>
                <p class="mb-4 font-semibold text-gray-900 dark:text-white">
                    <span id="deleteMultiplePartenaireCount"></span> {{ 'app.js.partners.selected_count'|trans }}
                </p>
                <div class="flex justify-center items-center space-x-4">
                    <button onclick="closeModal('deleteMultiplePartenairesModal')" type="button" class="py-2 px-3 text-sm font-medium text-gray-500 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-primary-300 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600">
                        {{ 'app.js.partners.cancel'|trans }}
                    </button>
                    <button onclick="confirmDeleteMultiplePartenaires()" type="button" class="py-2 px-3 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600">
                        {{ 'app.js.partners.confirm_delete_btn'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Fonctions globales pour gérer les modales
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.removeAttribute('inert');
            modal.removeAttribute('aria-hidden');
            // Ajouter backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'bg-gray-900 bg-opacity-50 fixed inset-0 z-40';
            backdrop.id = 'modal-backdrop-' + modalId;
            backdrop.onclick = () => closeModal(modalId);
            document.body.appendChild(backdrop);
        }
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.setAttribute('inert', '');
            modal.setAttribute('aria-hidden', 'true');
            const backdrop = document.getElementById('modal-backdrop-' + modalId);
            if (backdrop) backdrop.remove();
        }
    }

    // Fonction pour afficher la modale de suppression multiple
    function showDeleteMultiplePartenairesModal(count) {
        document.getElementById('deleteMultiplePartenaireCount').textContent = count;
        openModal('deleteMultiplePartenairesModal');
    }

    // Fonction pour confirmer la suppression multiple
    function confirmDeleteMultiplePartenaires() {
        if (window.partenairesController) {
            closeModal('deleteMultiplePartenairesModal');
            window.partenairesController.executeDeleteMultiple();
        }
    }
</script>

{% endblock %}
