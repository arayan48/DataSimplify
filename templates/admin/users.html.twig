{% extends 'base.html.twig' %}

{% block title %}{{ 'app.admin.users'|trans }} - CITC{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/admin/sidebar.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/admin/users.css') }}">
    <style>
        body > header,
        body > footer {
            display: none;
        }
        body > main {
            padding: 0;
        }
        .filters-container {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        .filter-group {
            flex: 1;
        }
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        .filter-input,
        .filter-select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9375rem;
        }
        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #007bff;
        }
        .btn-reset {
            padding: 0.625rem 1.25rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-reset:hover {
            background: #5a6268;
        }
        .user-row-clickable {
            cursor: pointer;
        }
        .user-row-clickable:hover {
            background-color: #f8f9fa;
        }
        .detail-modal .modal-content {
            max-width: 600px;
        }
        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .user-detail-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .user-detail-item label {
            display: block;
            font-weight: 600;
            color: #666;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .user-detail-item .value {
            font-size: 1rem;
            color: #333;
        }
        .detail-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        .btn-icon-text {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-icon-text svg {
            width: 18px;
            height: 18px;
        }
        .btn-edit {
            background: #007bff;
            color: white;
        }
        .btn-edit:hover {
            background: #0056b3;
        }
        .btn-close-detail {
            background: #6c757d;
            color: white;
        }
        .btn-close-detail:hover {
            background: #5a6268;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
        }
    </style>
{% endblock %}

{% block body %}
<div class="admin-container" data-controller="users"
     data-users-add-user-value="{{ 'app.js.users.add_user'|trans }}"
     data-users-edit-user-value="{{ 'app.js.users.edit_user'|trans }}"
     data-users-password-required-value="{{ 'app.js.users.password_required'|trans }}"
     data-users-confirm-delete-multiple-value="{{ 'app.js.users.confirm_delete_multiple'|trans }}"
     data-users-confirm-delete-single-value="{{ 'app.js.users.confirm_delete_single'|trans }}"
     data-users-success-value="{{ 'app.js.users.success'|trans }}"
     data-users-error-value="{{ 'app.js.users.error'|trans }}"
     data-users-password-generated-value="{{ 'app.js.users.password_generated'|trans }}">
    {% include 'admin/_sidebar.html.twig' %}

    <main class="admin-content">
        <div class="page-header">
            <h1>{{ 'app.common.users_management'|trans }}</h1>
            <div class="header-actions">
                <button class="btn btn-danger" data-action="click->users#deleteSelected" data-users-target="deleteBtn" disabled>
                    {{ 'app.common.delete_selection'|trans }}
                </button>
                <button class="btn btn-primary" data-action="click->users#openCreateModal">
                    + {{ 'app.common.add_user'|trans }}
                </button>
            </div>
        </div>

        <!-- Filtres et Recherche -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label>{{ 'app.common.search'|trans }}</label>
                    <input type="text" class="filter-input" placeholder="{{ 'app.common.first_name'|trans }}, {{ 'app.common.last_name'|trans }}, {{ 'app.common.username'|trans }}..." 
                    data-users-target="searchInput" 
                    data-action="input->users#filterUsers">
                </div>
                <div class="filter-group">
                    <label>{{ 'app.common.role'|trans }}</label>
                    <select class="filter-select" data-users-target="roleFilter" data-action="change->users#filterUsers">
                        <option value="">{{ 'app.common.all_roles'|trans }}</option>
                        <option value="ROLE_ADMINISTRATEUR">{{ 'app.common.administrator'|trans }}</option>
                        <option value="ROLE_ADMINISTRATION">{{ 'app.common.administration'|trans }}</option>
                        <option value="ROLE_USER">{{ 'app.common.user_role'|trans }}</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>{{ 'app.common.partner'|trans }}</label>
                    <select class="filter-select" data-users-target="partenaireFilter" data-action="change->users#filterUsers">
                        <option value="">{{ 'app.common.all_partners'|trans }}</option>
                        <option value="none">{{ 'app.common.no_partner'|trans }}</option>
                        {% for partenaire in partenaires %}
                        <option value="{{ partenaire.id }}">{{ partenaire.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group" style="flex: 0 0 auto;">
                    <button class="btn-reset" data-action="click->users#resetFilters">{{ 'app.common.reset'|trans }}</button>
                </div>
            </div>
        </div>

        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th width="40">
                            <input type="checkbox" data-action="change->users#toggleAll" data-users-target="checkAll">
                        </th>
                        <th>{{ 'app.common.email'|trans }}</th>
                        <th>{{ 'app.common.username'|trans }}</th>                        
                        <th>{{ 'app.common.first_name'|trans }}</th>
                        <th>{{ 'app.common.last_name'|trans }}</th>
                        <th>{{ 'app.common.partner'|trans }}</th>
                        <th>{{ 'app.common.role'|trans }}</th>
                        <th width="100">{{ 'app.common.actions'|trans }}</th>
                    </tr>
                </thead>
                <tbody data-users-target="tableBody">
                    {% for user in users %}
                    <tr data-users-target="userRow"
                        class="user-row-clickable"
                        data-action="click->users#showUserDetail"
                        data-user-id="{{ user.id }}"
                        data-email="{{ user.email }}"
                        data-username="{{ user.username }}"
                        data-prenom="{{ user.prenom }}"
                        data-nom="{{ user.nom }}"
                        data-partnaire-name="{{ user.partnaireId|partenaire_name }}"
                        data-partnaire-id="{{ user.partnaireId ?? '' }}"
                        data-roles="{{ user.roles|json_encode }}">
                        <td>
                            <input type="checkbox" class="user-checkbox" value="{{ user.id }}" 
                                data-action="change->users#updateDeleteBtn" 
                                data-users-target="checkbox">
                        </td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.username ?? '-' }}</td>
                        <td>{{ user.prenom ?? '-' }}</td>
                        <td>{{ user.nom ?? '-' }}</td>
                        <td>{{ user.partnaireId ? (user.partnaireId|partenaire_name) : '-' }}</td>
                        <td>
                            {% if 'ROLE_ADMINISTRATEUR' in user.roles %}
                                <span class="badge badge-danger">{{ 'app.common.administrator'|trans }}</span>
                            {% elseif 'ROLE_ADMINISTRATION' in user.roles %}
                                <span class="badge badge-warning">{{ 'app.common.administration'|trans }}</span>
                            {% else %}
                                <span class="badge badge-default">{{ 'app.common.user_role'|trans }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-icon" data-action="click->users#openEditModal" 
                                    data-user-id="{{ user.id }}"
                                    data-user-email="{{ user.email }}"
                                    data-user-username="{{ user.username }}"
                                    data-user-prenom="{{ user.prenom }}"
                                    data-user-nom="{{ user.nom }}"
                                    data-user-partnaire-id="{{ user.partnaireId ?? '' }}"
                                    data-user-roles="{{ user.roles|json_encode }}"
                                    title="{{ 'app.common.edit'|trans }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                            {{ 'app.common.empty'|trans }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal" data-users-target="modal">
        <div class="modal-overlay" data-action="click->users#closeModal"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-users-target="modalTitle">{{ 'app.common.add_user'|trans }}</h2>
                <button class="modal-close" data-action="click->users#closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form data-users-target="form" data-action="submit->users#submitForm">
                    <input type="hidden" data-users-target="userId">
                    
                    <div class="form-group">
                        <label>{{ 'app.common.email'|trans }}</label>
                        <input type="email" class="form-control" data-users-target="emailInput" required>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.username'|trans }}</label>
                        <input type="text" class="form-control" data-users-target="usernameInput" required>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.first_name'|trans }}</label>
                        <input type="text" class="form-control" data-users-target="prenomInput" required>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.last_name'|trans }}</label>
                        <input type="text" class="form-control" data-users-target="nomInput" required>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.partner'|trans }}</label>
                        <select class="form-control" data-users-target="partenaireSelect">
                            <option value="">{{ 'app.common.no_partner'|trans }}</option>
                            {% for partenaire in partenaires %}
                            <option value="{{ partenaire.id }}">{{ partenaire.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.password'|trans }}</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="position: relative; flex: 1;">
                                <input type="password" class="form-control" data-users-target="passwordInput" style="padding-right: 2.5rem;">
                                <button type="button" class="btn-eye" data-action="click->users#togglePasswordVisibility" data-users-target="togglePassword" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                            </div>
                            <button type="button" class="btn btn-secondary" data-action="click->users#generatePassword" style="white-space: nowrap;">
                                {{ 'app.common.generate'|trans }}
                            </button>
                        </div>
                        <small data-users-target="passwordHelp">{{ 'app.common.password_help'|trans }}</small>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.password_confirm'|trans }}</label>
                        <div style="position: relative;">
                            <input type="password" class="form-control" data-users-target="passwordConfirmInput" style="padding-right: 2.5rem;">
                            <button type="button" class="btn-eye" data-action="click->users#togglePasswordConfirmVisibility" data-users-target="togglePasswordConfirm" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                        <small data-users-target="passwordError" style="color: #e74c3c; display: none;">{{ 'Les mots de passe ne correspondent pas'|trans }}</small>
                    </div>

                    <div class="form-group">
                        <label>{{ 'app.common.role'|trans }}</label>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" value="ROLE_USER" data-users-target="roleCheckbox" checked>
                                {{ 'app.common.user_role'|trans }}
                            </label>
                            <label>
                                <input type="checkbox" value="ROLE_ADMINISTRATION" data-users-target="roleCheckbox">
                                {{ 'app.common.administration'|trans }}
                            </label>
                            <label>
                                <input type="checkbox" value="ROLE_ADMINISTRATEUR" data-users-target="roleCheckbox">
                                {{ 'app.common.administrator'|trans }}
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-action="click->users#closeModal">{{ 'app.common.cancel'|trans }}</button>
                        <button type="submit" class="btn btn-primary">{{ 'app.common.save'|trans }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal DÃ©tails Utilisateur -->
    <div class="modal detail-modal" data-users-target="detailModal">
        <div class="modal-overlay" data-action="click->users#closeDetailModal"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ 'app.common.edit_user'|trans }}</h2>
                <button class="modal-close" data-action="click->users#closeDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-detail-grid">
                    <div class="user-detail-item">
                        <label>{{ 'app.common.email'|trans }}</label>
                        <div class="value" data-users-target="detailEmail">-</div>
                    </div>
                    <div class="user-detail-item">
                        <label>{{ 'app.common.username'|trans }}</label>
                        <div class="value" data-users-target="detailUsername">-</div>
                    </div>
                    <div class="user-detail-item">
                        <label>{{ 'app.common.first_name'|trans }}</label>
                        <div class="value" data-users-target="detailPrenom">-</div>
                    </div>
                    <div class="user-detail-item">
                        <label>{{ 'app.common.last_name'|trans }}</label>
                        <div class="value" data-users-target="detailNom">-</div>
                    </div>
                    <div class="user-detail-item">
                        <label>{{ 'app.common.partner'|trans }}</label>
                        <div class="value" data-users-target="detailPartenaire">-</div>
                    </div>
                    <div class="user-detail-item">
                        <label>{{ 'app.common.role'|trans }}</label>
                        <div class="value" data-users-target="detailRoles">-</div>
                    </div>
                </div>
                <div class="detail-actions">
                    <button class="btn-icon-text btn-delete" data-action="click->users#deleteFromDetail" data-users-target="deleteFromDetailBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                        {{ 'app.common.delete'|trans }}
                    </button>
                    <button class="btn-icon-text btn-close-detail" data-action="click->users#closeDetailModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        {{ 'app.common.close'|trans }}
                    </button>
                    <button class="btn-icon-text btn-edit" data-action="click->users#editFromDetail" data-users-target="editFromDetailBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        {{ 'app.common.edit'|trans }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
